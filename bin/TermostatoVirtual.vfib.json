{"name":"TermostatoVirtual","type":"virtual_device","properties":{"deviceIcon":1059,"currentIcon":"1059","log":"","logTemp":"","mainLoop":"iconoId = 1059\n\n--[[----- CONFIGURACION AVANZADA ---------------------------------------------]]\nlocal _selfId = fibaro:getSelfId()  -- ID de este dispositivo virtual\n--[[----- FIN CONFIGURACION AVANZADA -----------------------------------------]]\n\nfibaro:call(_selfId, \"setProperty\", \"ui.separador.value\", '======')\nfibaro:call(_selfId, \"setProperty\", \"ui.actualConsigna.value\", '20ºC / 21ºC')\n-- refrescar icono\nfibaro:call(_selfId, 'setProperty', \"currentIcon\", iconoId)\n\n--[[ comparar timestamp con os.time()\n  si es menor\n    tomar temperatura del panel\n\n  si en mayor\n    tomar temperatura del VD\n\n  actualizar etiqueta de tiempo\n--]]\n","ui.Label2.value":"","ui.Label3.value":"","ui.actualConsigna.value":"20ºC / 21ºC","ui.panelLabel.value":"538-Prueba","ui.separador.value":"======","ui.timeLabel.value":"","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"","name":"actualConsigna","favourite":false,"main":true}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"Tiempo:","name":"timeLabel","favourite":false,"main":false}]},{"type":"button","elements":[{"id":3,"lua":true,"waitForResponse":false,"caption":"- h","name":"Button31","empty":false,"msg":"--[[\nactualizar timestamp con la etiqueta de tiempo\n--]]","buttonIcon":0,"favourite":false,"main":false},{"id":4,"lua":true,"waitForResponse":false,"caption":"+ h","name":"Button32","empty":false,"msg":"--[[\nactualizar timestamp con la etiqueta de tiempo\n--]]","buttonIcon":0,"favourite":false,"main":false},{"id":5,"lua":true,"waitForResponse":false,"caption":"- min","name":"Button33","empty":false,"msg":"--[[▼\nactualizar timestamp con la etiqueta de tiempo\n--]]","buttonIcon":0,"favourite":false,"main":false},{"id":6,"lua":true,"waitForResponse":false,"caption":"+ min","name":"Button34","empty":false,"msg":"--[[▲\nactualizar timestamp con la etiqueta de tiempo\n--]]","buttonIcon":0,"favourite":false,"main":false}]},{"type":"button","elements":[{"id":7,"lua":false,"waitForResponse":false,"caption":"- ºC","name":"Button21","empty":false,"msg":"Secuencia para enviar","buttonIcon":0,"favourite":false,"main":false},{"id":8,"lua":false,"waitForResponse":false,"caption":"+ ºC","name":"Button22","empty":false,"msg":"Secuencia para enviar","buttonIcon":0,"favourite":false,"main":false},{"id":9,"lua":false,"waitForResponse":false,"caption":"Eco","name":"Button23","empty":false,"msg":"Secuencia para enviar","buttonIcon":0,"favourite":false,"main":false},{"id":10,"lua":false,"waitForResponse":false,"caption":"Off","name":"Button24","empty":false,"msg":"Secuencia para enviar","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":11,"lua":false,"waitForResponse":false,"caption":"===============","name":"separador","favourite":false,"main":false}]},{"type":"label","elements":[{"id":12,"lua":false,"waitForResponse":false,"caption":"Panel:","name":"panelLabel","favourite":false,"main":false}]},{"type":"label","elements":[{"id":13,"lua":false,"waitForResponse":false,"caption":"Sonda:","name":"Label2","favourite":false,"main":false}]},{"type":"label","elements":[{"id":14,"lua":false,"waitForResponse":false,"caption":"Actuador:","name":"Label3","favourite":false,"main":false}]},{"type":"button","elements":[{"id":15,"lua":true,"waitForResponse":false,"caption":"Panel","name":"psnelButton","empty":false,"msg":"--[[TermostatoVirtual\n\tDispositivo virtual\n\tpsnelButton.lua\n\tpor Manuel Pascual\n------------------------------------------------------------------------------]]\n\n--[[----- CONFIGURACION AVANZADA ---------------------------------------------]]\nlocal _selfId = fibaro:getSelfId()  -- ID de este dispositivo virtual\n--[[----- FIN CONFIGURACION AVANZADA -----------------------------------------]]\n\nif not HC2 then\n  HC2 = Net.FHttp(\"127.0.0.1\", 11111)\nend\n-- obtener zonas\nresponse ,status, errorCode = HC2:GET(\"/api/panels/heating\")\nlocal zonas = json.decode(response)\n\n-- seleccionar la siguiete zona que corresponda\nlocal zona = fibaro:get(_selfId, 'ui.panelLabel.value')\nlocal myKey = 1\nlocal zonas = json.decode(response)\nfor key, value in pairs(zonas) do\n  if value.id..'-'..value.name == zona then\n    if key < #zonas then myKey = key + 1 else myKey = 1 end\n    break\n  else\n    myKey = #zonas\n  end\nend\n\n-- actualizar la etiqueta del panel\nfibaro:call(_selfId, \"setProperty\", \"ui.panelLabel.value\",\n zonas[myKey].id..'-'..zonas[myKey].name) -- ..' '..'00ºC/00ºC'\n\n-- actualizar las etiquetas con estado real de temperatura\n--fibaro:call(_selfId, \"pressButton\", \"13\")","buttonIcon":0,"favourite":false,"main":true},{"id":16,"lua":false,"waitForResponse":false,"caption":"Sonda","name":"Button12","empty":false,"msg":"Secuencia para enviar","buttonIcon":0,"favourite":false,"main":false},{"id":17,"lua":false,"waitForResponse":false,"caption":"Actuador","name":"Button13","empty":false,"msg":"Secuencia para enviar","buttonIcon":0,"favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}